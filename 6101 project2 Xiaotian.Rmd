---
title: "6101 Project2"
author: "Xiaotian Huang"
date: "11/23/2019"
output: html_document
---

```{r basicfcn}
# can add quietly=T option to the require() function
loadPkg = function(x) { if (!require(x,character.only=T, quietly =T)) { install.packages(x,dep=T,repos="http://cran.us.r-project.org"); if(!require(x,character.only=T)) stop("Package not found") } }
```

## Chapter 1: Introduction of Cardiovascular Disease:

Based on The World Health Organization (WHO), Cardiovascular diseases (CVDs) are disorders related to the heart and blood vessels. The diseases mainly caused by fatty deposits plaque builds up on the inner walls of the blood vessels which prevent prevents blood from flowing to the heart or brain. 

![As plaque builds up in the arteries of a person with heart disease, the inside of the arteries begins to narrow, which lessens or blocks the flow of blood.](CVD picture.jpg)


According to 2016 report, cardiovascular disease remains the leading cause of death in the United States (Benjamin et al., 2019). Around 80% of CVD deaths are a heart attack and stroke. The cause of cardiovascular diseases is usually the presence of a combination of risk factors, such as unhealthy diet, obesity, physical inactivity, tobacco use and harmful use of alcohol.

Since there are many reports indicated that the cause of cardiovascular diseases is associated with our lifestyle. Therefore, we want to use this dataset to validate a person's behavior and developing of the disease.

## Chapter 2: Description of Data and Exploratory Data Analysis

### 2.1 Source Data
The source data for our EDA is a CSV containing 70 000 records of patients data in 12 features: age, height, weight, gender, systolic blood pressure, diastolic blood pressure, cholesterol, glucose, smoking, alcohol intake, physical activity, and presence or absence of cardiovascular disease. (https://www.kaggle.com/sulianova/cardiovascular-disease-dataset)
```{r, echo=FALSE}
cardio <- read.csv("cardio_train.csv", sep = ";")
cardio$gender <- as.factor(cardio$gender)
cardio$smoke <- as.factor(cardio$smoke)
cardio$alco <- as.factor(cardio$alco)
cardio$cholesterol <- as.factor(cardio$cholesterol)
cardio$gluc <- as.factor(cardio$gluc)
cardio$active <- as.factor(cardio$active)
cardio$cardio <- as.factor(cardio$cardio)
str(cardio)
```
### 2.2 Preprocessing Data

We noticed that variable 'age' is int(day), which were converted into int(years).As height and weight individually do not mean much to patients' health, so we calculated Body Mass Index (BMI), a measure of body fat based on height and weight that applies to adult men and women, and added it as a feature. Also column 'id' was droped.
```{r, echo=F}
cardio <- subset(cardio, select=-c(id))
cardio$age <- round((cardio$age)/365)
cardio$bmi <- cardio$weight/((cardio$height/100)^2)
summary(cardio)
```

We noticed that the min value of systolic blood pressure(ap_hi) and diastolic blood pressure (ap_lo) are negative values, which do not make sense. In addition, diastolic blood pressure is supposed to be lower than systolic blood pressure. The data were further cleaned based on these crterion.

```{r, echo=F}
cardio <- cardio[which(cardio$ap_hi > 0), ]
cardio <- cardio[which(cardio$ap_lo > 0), ]
cardio <- cardio[which(cardio$ap_lo < cardio$ap_hi), ]
```

Then the distribution of age, height, weight, ap_hi and ap_lo was checked.

```{r, echo=F}
library('ggplot2')
ggplot(data=cardio, aes(x=age))+
  geom_histogram(fill="orange", col = "black", binwidth = 5)+
  ggtitle("Histogram of Age")+
  xlab("Age") + 
  ylab("Count") + 
  theme(axis.title = element_text(colour = "#7a7a78"))+
  theme(axis.text = element_text(colour = "#7a7a78"))+
  theme(plot.title= element_text(hjust=0.5, size = 14))
ggplot(data=cardio, aes(x=height))+
  geom_histogram(fill="green", col = "black", binwidth = 10)+
  ggtitle("Histogram of Height")+
  xlab("Height") + 
  ylab("Count") + 
  theme(axis.title = element_text(colour = "#7a7a78"))+
  theme(axis.text = element_text(colour = "#7a7a78"))+
  theme(plot.title= element_text(hjust=0.5, size = 14))
ggplot(data=cardio, aes(x=weight))+
  geom_histogram(fill="yellow", col = "black", binwidth = 10)+
  ggtitle("Histogram of Weight")+
  xlab("Weight") + 
  ylab("Count") + 
  theme(axis.title = element_text(colour = "#7a7a78"))+
  theme(axis.text = element_text(colour = "#7a7a78"))+
  theme(plot.title= element_text(hjust=0.5, size = 14))
ggplot(data=cardio, aes(x=ap_hi))+
  geom_histogram(fill="blue", col = "black", binwidth = 10)+
  ggtitle("Histogram of Systolic Blood Pressure")+
  xlab("Systolic blood pressure") + 
  ylab("Count") + 
  theme(axis.title = element_text(colour = "#7a7a78"))+
  theme(axis.text = element_text(colour = "#7a7a78"))+
  theme(plot.title= element_text(hjust=0.5, size = 14))
ggplot(data=cardio, aes(x=ap_lo))+
  geom_histogram(fill="red", col = "black", binwidth = 10)+
  ggtitle("Histogram of Diastolic Blood Pressure")+
  xlab("Diastolic blood pressure") + 
  ylab("Count") + 
  theme(axis.title = element_text(colour = "#7a7a78"))+
  theme(axis.text = element_text(colour = "#7a7a78"))+
  theme(plot.title= element_text(hjust=0.5, size = 14))
```

The histogram of age shows that there are only few observation for age<35, which could not represent the population of age<35, so the observations with age<35 were droped. For height, weight, ap_hi, and ap_lo, the histograms were way skewed by some extreme outliers, which were droped in this step.

```{r outlierKD_def, include=FALSE}
# modified to allow prompt-free run-through
outlierKD <- function(dt, var, rmv=NULL) { 
     var_name <- eval(substitute(var),eval(dt))
     na1 <- sum(is.na(var_name))
     m1 <- mean(var_name, na.rm = T)
     sd1 <- sd(var_name,na.rm = T)
     par(mfrow=c(2, 2), oma=c(0,0,3,0))
     boxplot(var_name, main="With outliers")
     hist(var_name, main="With outliers", xlab=NA, ylab=NA)
     outlier <- boxplot.stats(var_name)$out
     mo <- mean(outlier)
     var_name <- ifelse(var_name %in% outlier, NA, var_name)
     boxplot(var_name, main="Without outliers")
     hist(var_name, main="Without outliers", xlab=NA, ylab=NA)
     title("Outlier Check", outer=TRUE)
     na2 <- sum(is.na(var_name))
     cat("Outliers identified:", na2 - na1, "n")
     cat("Propotion (%) of outliers:", round((na2 - na1) / sum(!is.na(var_name))*100, 1), "n")
     cat("Mean of the outliers:", round(mo, 2), "n")
     m2 <- mean(var_name, na.rm = T)
     cat("Mean without removing outliers:", round(m1, 2), "n")
     cat("Mean if we remove outliers:", round(m2, 2), "n")
     #
     if(is.null(rmv)) { 
       response <- readline(prompt="Do you want to remove outliers and to replace with NA? [yes/no]: ") 
     } else {
       if (rmv=='y'|rmv=='yes'|rmv=='Y'|rmv=='Yes'|rmv=='YES'|rmv==TRUE ) { response = 'y' } else { response = 'n' }
     }
     #
     if(response == "y" | response == "yes"){
          dt[as.character(substitute(var))] <- invisible(var_name)
          assign(as.character(as.list(match.call())$dt), dt, envir = .GlobalEnv)
          cat("Outliers successfully removed", "n")
          return(invisible(dt))
     } else{
          cat("Nothing changed", "n")
          return(invisible(var_name))
     }
}
```
```{r, include=FALSE}
cardio <- cardio[which(cardio$age > 35), ]
outlierKD(cardio, height, 'y')
outlierKD(cardio, weight, 'y')
outlierKD(cardio, ap_hi, 'y')
outlierKD(cardio, ap_lo, 'y')
cardio <- na.omit(cardio)
```

The distribution of age, height, weight, ap_hi and ap_lo was checked again after outliers removed.

```{r, echo=F}
ggplot(data=cardio, aes(x=age))+
  geom_histogram(fill="orange", col = "black", binwidth = 5)+
  ggtitle("Histogram of Age")+
  xlab("Age") + 
  ylab("Count") + 
  theme(axis.title = element_text(colour = "#7a7a78"))+
  theme(axis.text = element_text(colour = "#7a7a78"))+
  theme(plot.title= element_text(hjust=0.5, size = 14))
ggplot(data=cardio, aes(x=height))+
  geom_histogram(fill="green", col = "black", binwidth = 5)+
  ggtitle("Histogram of Height")+
  xlab("Height") + 
  ylab("Count") + 
  theme(axis.title = element_text(colour = "#7a7a78"))+
  theme(axis.text = element_text(colour = "#7a7a78"))+
  theme(plot.title= element_text(hjust=0.5, size = 14))
ggplot(data=cardio, aes(x=weight))+
  geom_histogram(fill="yellow", col = "black", binwidth = 5)+
  ggtitle("Histogram of Weight")+
  xlab("Weight") + 
  ylab("Count") + 
  theme(axis.title = element_text(colour = "#7a7a78"))+
  theme(axis.text = element_text(colour = "#7a7a78"))+
  theme(plot.title= element_text(hjust=0.5, size = 14))
ggplot(data=cardio, aes(x=ap_hi))+
  geom_histogram(fill="blue", col = "black", binwidth = 10)+
  ggtitle("Histogram of Systolic Blood Pressure")+
  xlab("Systolic blood pressure") + 
  ylab("Count") + 
  theme(axis.title = element_text(colour = "#7a7a78"))+
  theme(axis.text = element_text(colour = "#7a7a78"))+
  theme(plot.title= element_text(hjust=0.5, size = 14))
ggplot(data=cardio, aes(x=ap_lo))+
  geom_histogram(fill="red", col = "black", binwidth = 10)+
  ggtitle("Histogram of Diastolic Blood Pressure")+
  xlab("Diastolic blood pressure") + 
  ylab("Count") + 
  theme(axis.title = element_text(colour = "#7a7a78"))+
  theme(axis.text = element_text(colour = "#7a7a78"))+
  theme(plot.title= element_text(hjust=0.5, size = 14))
qqnorm(cardio$height, main="Q-Q plot of Height") 
qqline(cardio$height)
qqnorm(cardio$weight, main="Q-Q plot of Weight") 
qqline(cardio$weight)
qqnorm(cardio$ap_hi, main="Q-Q plot of Systolic Blood Pressure") 
qqline(cardio$ap_hi)
qqnorm(cardio$ap_lo, main="Q-Q plot of Diastolic Blood Pressure") 
qqline(cardio$ap_lo)
```

### Correlations among Different Variables

The correlation matrix was displayed to get an idea of the correlations among different variables.

```{r, echo=F}
library("corrplot")
ccor<-cor(cardio[c("age", "bmi", "ap_hi", "ap_lo")])
corrplot(ccor)
```

## Chapter 3: Cardio
### 3.1 SMART Question

What are the risk factors of cardiovascular diseases? Is age, height, weight, ap-hi, ap-lo correlated to the development of cardiovascular disease?

### 3.2.1 Basic analyze
```{r model1, echo=FALSE}
cardiologit <- glm(cardio ~ age, data = cardio, family = "binomial")
summary(cardiologit)
```

```{r model2, echo=FALSE}
cardiologit2 <- glm(cardio ~ age + height + weight, data = cardio, family = "binomial")
summary(cardiologit2)
```


```{r model3, echo=FALSE}
cardiologit3 <- glm(cardio ~ age + height + weight + ap_hi + ap_lo, data = cardio, family = "binomial")
summary(cardiologit3)
```

#### 3.2.2 ROC curve and AUC

```{r roc_auc}
loadPkg("pROC")
prob=predict(cardiologit, type = c("response"))
cardio$prob=prob
h <- roc(cardio~prob, data=cardio)
auc(h) # area-under-curve prefer 0.8 or higher.
plot(h)
# detach("package:pROC", unload = T) # good habit to remove unload packages no longer needed 
```

```{r roc_auc2}
loadPkg("pROC")
prob=predict(cardiologit2, type = c("response"))
cardio$prob=prob
h <- roc(cardio~prob, data=cardio)
auc(h) # area-under-curve prefer 0.8 or higher.
plot(h)
# detach("package:pROC", unload = T) # good habit to remove unload packages no longer needed 
```

```{r roc_auc3}
loadPkg("pROC")
prob=predict(cardiologit3, type = c("response"))
cardio$prob=prob
h <- roc(cardio~prob, data=cardio)
auc(h) # area-under-curve prefer 0.8 or higher.
plot(h)
# detach("package:pROC", unload = T) # good habit to remove unload packages no longer needed 
```


We have here the area-under-curve of `r auc(h)`, which is less than 0.8. This test agrees that the model is not considered a good fit. 

#### 3.2.3 McFadden  

```{r McFadden}
loadPkg("pscl")
cardioLogitpr1 = pR2(cardiologit)
cardioLogitpr1
# detach("package:pscl", unload = T) # good habit to remove unload packages no longer needed 
```

With the McFadden value of `r cardioLogitpr1['McFadden']`, which is analgous to the coefficient of determination R$2$, only about 4% of the variations in y is explained by the explanatory variables in the model. 

A major weakness of the overall model is likely from the small dataset sample size of `r length(cardio$cardio)`. We expect a much higher number of observations will increase the sensitivity of the model.


```{r McFadden2}
loadPkg("pscl")
cardioLogitpr2 = pR2(cardiologit2)
cardioLogitpr2
```

With the McFadden value of `r cardioLogitpr2['McFadden']`, which is analgous to the coefficient of determination R$2$, only about 6% of the variations in y is explained by the explanatory variables in the model. 

A major weakness of the overall model is likely from the small dataset sample size of `r length(cardio$cardio)`. We expect a much higher number of observations will increase the sensitivity of the model.

```{r McFadden3}
loadPkg("pscl")
cardioLogitpr3 = pR2(cardiologit3)
cardioLogitpr3
```

With the McFadden value of `r cardioLogitpr3['McFadden']`, which is analgous to the coefficient of determination R$2$, about 16% of the variations in y is explained by the explanatory variables in the model. We improve our model.

## Chapter 4: PCA
### 4.1 SMART Question

### 4.2 Basic analyze
```{r 4.2, echo=F}
dfpca <- subset(cardio, select = -c(gender, cholesterol, gluc, smoke, alco, active, cardio))
```

```{r 4.2.1, include=F}
pr.out =prcomp(dfpca , scale =TRUE)
pr.out.nc =prcomp(dfpca , scale =FALSE)
summary(pr.out)
pr.out$rotation
summary(pr.out.nc)
pr.out.nc$rotation
```

```{r 4.2.2, echo=F}
#Let us plot the cumulation of variance using the sd
pr.var <- (pr.out$sdev^2)
pve <- pr.var/sum(pr.var)
plot(cumsum(pve), xlab="Principal Component (standardized)", ylab ="Cumulative Proportion of Variance Explained",ylim=c(0,1),type="b")
pr.var.nc <- (pr.out.nc$sdev^2)
pve.nc <- pr.var.nc/sum(pr.var.nc)
plot(cumsum(pve.nc), xlab="Principal Component (non-standardized)", ylab ="Cumulative Proportion of Variance Explained",ylim=c(0,1),type="b")

```

```{r 4.2.3, echo=F}
#biplot(pr.out, scale =0)
#biplot(pr.out.nc, scale =0)
```



## Chapter 5: KNN

```{r 5.1, echo=F}
head(cardio)
str(cardio)
summary(cardio)
scaledcardio <- as.data.frame(scale(cardio[3:6], center = TRUE, scale = TRUE)) #not invovle age
set.seed(1)
cardio_sample <- sample(2, nrow(scaledcardio), replace=TRUE, prob=c(0.70, 0.30))
```

```{r 5.2, include=F}
cardio_training <- scaledcardio [cardio_sample==1, 1:4] #有问题
cardio_test <- scaledcardio [cardio_sample==2, 1:4]
cardio.trainLabels <- cardio[cardio_sample==1, 12]
cardio.testLabels <- cardio[cardio_sample==2, 12]
```

```{r Q3, echo=F}
loadPkg("class")
cardio_pred <- knn(train = cardio_training, test = cardio_test, cl=cardio.trainLabels, k=3)
cardio_pred
loadPkg("gmodels")
cardioPREDCross <- CrossTable(cardio.testLabels, cardio_pred, prop.chisq = FALSE)

cardio_pred1 <- knn(train = cardio_training, test = cardio_test, cl=cardio.trainLabels, k=6)
cardio_pred1
loadPkg("gmodels")
cardioPREDCross <- CrossTable(cardio.testLabels, cardio_pred1, prop.chisq = FALSE)

cardio_pred2 <- knn(train = cardio_training, test = cardio_test, cl=cardio.trainLabels, k=9)
cardio_pred2
loadPkg("gmodels")
cardioPREDCross <- CrossTable(cardio.testLabels, cardio_pred2, prop.chisq = FALSE)



cardio_train_rows = sample(1:nrow(scaledcardio), 
                              round(0.7 * nrow(cardio), 0),  
                              replace = FALSE)

cardio_train = cardio[cardio_train_rows, ]
cardio_test = cardio[-cardio_train_rows, ] 
set.seed(1)
cardio_3NN = knn(train = cardio_train[, c("age","height", "weight", "ap_hi", "ap_lo")],  #<- training set cases
               test = cardio_test[, c("age","height", "weight", "ap_hi", "ap_lo")],    #<- test set cases
               cl = cardio_train[, "cardio"],                         #<- category for true classification
               k = 3)
set.seed(1)
cardio_6NN = knn(train = cardio_train[, c("age","height", "weight", "ap_hi", "ap_lo")],  #<- training set cases
               test = cardio_test[, c("age","height", "weight", "ap_hi", "ap_lo")],    #<- test set cases
               cl = cardio_train[, "cardio"],                         #<- category for true classification
               k = 6)
set.seed(1)
cardio_9NN = knn(train = cardio_train[, c("age","height", "weight", "ap_hi", "ap_lo")],  #<- training set cases
               test = cardio_test[, c("age","height", "weight", "ap_hi", "ap_lo")],    #<- test set cases
               cl = cardio_train[, "cardio"],                         #<- category for true classification
               k = 9)

```

```{r Q41, echo=F}
kNN_res = table(cardio_3NN,
                cardio_test$`cardio`)
kNN_res
sum(kNN_res)
kNN_res[row(kNN_res) == col(kNN_res)]
kNN_acc3 = sum(kNN_res[row(kNN_res) == col(kNN_res)]) / sum(kNN_res)
kNN_acc3

kNN_res = table(cardio_6NN,
                cardio_test$`cardio`)
kNN_res
sum(kNN_res)
kNN_res[row(kNN_res) == col(kNN_res)]
kNN_acc6 = sum(kNN_res[row(kNN_res) == col(kNN_res)]) / sum(kNN_res)
kNN_acc6

kNN_res = table(cardio_9NN,
                cardio_test$`cardio`)
kNN_res
sum(kNN_res)
kNN_res[row(kNN_res) == col(kNN_res)]
kNN_acc9 = sum(kNN_res[row(kNN_res) == col(kNN_res)]) / sum(kNN_res)
kNN_acc9

```